#ifndef RS_H_INCLUDED
#define RS_H_INCLUDED

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define PAUSA_PRESTADORES 5
#define PRE_RS 67  // M calculado como 67 (primo)

typedef struct {
    int DNI;
    char nombreyapellido[80];
    char servicios[120];
    char domicilio[80];
    char correo[50];
    char telefono[30];
} PrestadorRS;

typedef struct celdaRS {
    PrestadorRS datos; // Prestador de cabecera
    struct celdaRS *psig;
} CeldaRS;

typedef struct {
    CeldaRS a[PRE_RS];
    CeldaRS *anterior;
    CeldaRS *actual;
    int cant;
} RS;

// Función hashing para calcular la posición
int hashing_RS(int dni, int M) {
    char x[10];
    int longitud, i;
    int contador = 0;
    sprintf(x, "%d", dni);
    longitud = strlen(x);
    for (i = 0; i < longitud; i++)
        contador += ((int)x[i]) * (i + 1);
    return (contador % M);
}

// Inicializar la estructura RS
void init_RS(RS *tabla) {
    int i;
    tabla->cant = 0;
    for (i = 0; i < PRE_RS; i++) {
        tabla->a[i].psig = NULL;
    }
    tabla->actual = NULL;
    tabla->anterior = NULL;
}

// Crear una nueva celda para la lista enlazada
CeldaRS* nuevacelda(PrestadorRS prestador) {
    CeldaRS *nuevo = (CeldaRS*)malloc(sizeof(CeldaRS));
    if (nuevo == NULL) return NULL;
    nuevo->datos = prestador;
    nuevo->psig = NULL;
    return nuevo;
}

// Localizar prestador por DNI
int Localizar_RS(RS *tabla, int DNI, CeldaRS **resultado, int *costo) {
    int pos = hashing_RS(DNI, PRE_RS);
    int c = 0;
    CeldaRS *actual = tabla->a[pos].psig;
    while (actual != NULL) {
        c++;  // Cada consulta a un nodo aumenta el costo
        if (actual->datos.DNI == DNI) {
            *resultado = actual;
            *costo = c;
            return 1;  // Evocación exitosa
        }
        tabla->anterior = actual;
        actual = actual->psig;
    }
    *costo = c;
    return 0;  // No se encontró el DNI
}

// Insertar un prestador (alta)
int Alta_RS(RS *tabla, PrestadorRS prestador, int *costo) {
    CeldaRS *existe = NULL;
    int c = 0;
    int e = Localizar_RS(tabla, prestador.DNI, &existe, &c);
    int pos = hashing_RS(prestador.DNI, PRE_RS);
    c++;  // Consultar la posición del balde también tiene un costo
    *costo = c;

    if (e) {
        return 0;  // Prestador duplicado
    }

    CeldaRS *nuevo = nuevacelda(prestador);
    if (nuevo == NULL) {
        return -1;  // No hay más memoria
    }

    // Insertamos al inicio de la lista enlazada
    nuevo->psig = tabla->a[pos].psig;
    tabla->a[pos].psig = nuevo;
    tabla->cant = tabla->cant + 1;
    return 1;  // Alta exitosa
}

// Eliminar un prestador (baja)
int Baja_RS(RS *tabla, int DNI, int *costo) {
    int pos = hashing_RS(DNI, PRE_RS);
    int c = 0;
    CeldaRS *actual = tabla->a[pos].psig;
    CeldaRS *anterior = NULL;
    CeldaRS *existe = NULL;

    int e = Localizar_RS(tabla, DNI, &existe, &c);
    if (e == 0) {
        *costo = c;
        return 0;  // Prestador no existe
    }

    while (actual != NULL) {
        if (actual->datos.DNI == DNI) {
            if (anterior == NULL) {
                tabla->a[pos].psig = actual->psig;
            } else {
                anterior->psig = actual->psig;
            }
            free((void *)actual);
            tabla->cant = tabla->cant - 1;
            *costo = c;
            return 1;  // Baja exitosa
        }
        anterior = actual;
        actual = actual->psig;
        c++;  // Incrementar el costo por cada nodo
    }
    *costo = c;
    return 0;  // Baja no exitosa
}

// Evocar un prestador
int Evocar_RS(RS *tabla, int DNI, int *costo) {
    CeldaRS *prestador = NULL;
    int c;
    int e = Localizar_RS(tabla, DNI, &prestador, &c);
    *costo = c;
    return e;  // 1 si lo encontró, 0 si no
}

// Función para mostrar un prestador
void MostrarPrestador(PrestadorRS p) {
    printf("--------- Listado de Prestadores ---------\n");
    printf("DNI: %d\n", p.DNI);
    printf("Nombre y Apellido: %s\n", p.nombreyapellido);
    printf("Servicios: %s\n", p.servicios);
    printf("Domicilio: %s\n", p.domicilio);
    printf("Correo: %s\n", p.correo);
    printf("Telefono: %s\n", p.telefono);
}

// Mostrar la estructura con paginación
void MostrarEstructura_RS(RS *rs) {
    int i, contador = 0;
    for (i = 0; i < PRE_RS; i++) {
        printf("Posicion %d: ", i);
        if (rs->a[i].psig == NULL) {
            printf("*VACIA*\n");
        } else {
            printf("\n");
        }

        CeldaRS *actual = rs->a[i].psig;
        while (actual != NULL) {
            MostrarPrestador(actual->datos);
            printf("------------------------------------------\n");
            actual = actual->psig;
            contador++;

            if (contador % PAUSA_PRESTADORES == 0) {
                printf("Presione Enter para continuar...\n");
                getchar();  // Pausa tras cada 5 prestadores
            }
        }
    }
}
#endif // RS_H_INCLUDED

